%
% Methylacetate
%
\pgfplotstablecreatecol[create col/assign/.code={%
  \getthisrow{Etot}\entryval %
%  \ifnum\pgfplotstablerow>0
  \pgfmathsetmacro{\entryval}{min(\entryval,\pgfmathaccuma)}%
%  \fi
  \edef\pgfmathaccuma{\entryval} %
  \pgfkeyslet{/pgfplots/table/create col/next content}\entryval %
} %
]{Emin}\ScanMeOAc
\pgfplotstablecreatecol[create col/assign/.code={%
  \getthisrow{Etot}\entryval%
  \getthisrow{Emin}\refval%
%  %\ifnum\pgfplotstablerow>0
  \pgfmathsetmacro{\entryval}{\entryval - \refval}%
  \pgfmathsetmacro{\entryval}{\AUtoKJM * \entryval}%
%\fi
  \edef\pgfmathaccuma{\entryval} %
  \pgfkeyslet{/pgfplots/table/create col/next content}\entryval %
} %
]{Erel}\ScanMeOAc
\pgfplotstablesave[columns={Tau,Etot,Erel}]{\ScanMeOAc}{Results/ScanMeOAc.save.dat} 
%
% Methyl thioacetate
%
\pgfplotstablecreatecol[create col/assign/.code={%
  \getthisrow{Etot}\entryval%
  %  \ifnum\pgfplotstablerow>0
  \pgfmathsetmacro{\entryval}{min(\entryval,\pgfmathaccuma)}%
  %  \fi
  \edef\pgfmathaccuma{\entryval} %
  \pgfkeyslet{/pgfplots/table/create col/next content}\entryval %
}]{Emin}\ScanMeSAc %
\pgfplotstablecreatecol[%
create col/assign/.code={%
  \getthisrow{Etot}\entryval%
  \getthisrow{Emin}\refval%
  %  %\ifnum\pgfplotstablerow>0
  \pgfmathsetmacro{\entryval}{\entryval - \refval}%
  \pgfmathsetmacro{\entryval}{\AUtoKJM * \entryval}%
  %\fi
  \edef\pgfmathaccuma{\entryval} %
  \pgfkeyslet{/pgfplots/table/create col/next content}\entryval %
}]{Erel}\ScanMeSAc %
\pgfplotstablesave[columns={Tau,Etot,Erel}]{\ScanMeSAc}{Results/ScanMeSAc.save.dat} 
%
% Methylthionacetate
%
\pgfplotstablecreatecol[create col/assign/.code={%
  \getthisrow{Etot}\entryval %
  %  \ifnum\pgfplotstablerow>0
  \pgfmathsetmacro{\entryval}{min(\entryval,\pgfmathaccuma)}%
  %  \fi
  \edef\pgfmathaccuma{\entryval} %
  \pgfkeyslet{/pgfplots/table/create col/next content}\entryval %
} %
]{Emin}\ScanMeOCSMe
\pgfplotstablecreatecol[create col/assign/.code={%
  \getthisrow{Etot}\entryval%
  \getthisrow{Emin}\refval%
  %  %\ifnum\pgfplotstablerow>0
  \pgfmathsetmacro{\entryval}{\entryval - \refval}%
  \pgfmathsetmacro{\entryval}{\AUtoKJM * \entryval}%
  %\fi
  \edef\pgfmathaccuma{\entryval} %
  \pgfkeyslet{/pgfplots/table/create col/next content}\entryval %
} %
]{Erel}\ScanMeOCSMe
\pgfplotstablesave[columns={Tau,Etot,Erel}]{\ScanMeOCSMe}{Results/ScanMeOCSMe.save.dat} 
%
% Methyldithioacetate
%
\pgfplotstablecreatecol[create col/assign/.code={%
  \getthisrow{Etot}\entryval %
  %  \ifnum\pgfplotstablerow>0
  \pgfmathsetmacro{\entryval}{min(\entryval,\pgfmathaccuma)}%
  %  \fi
  \edef\pgfmathaccuma{\entryval} %
  \pgfkeyslet{/pgfplots/table/create col/next content}\entryval %
} %
]{Emin}\ScanMeSCSMe
\pgfplotstablecreatecol[create col/assign/.code={%
  \getthisrow{Etot}\entryval%
  \getthisrow{Emin}\refval%
  %  %\ifnum\pgfplotstablerow>0
  \pgfmathsetmacro{\entryval}{\entryval - \refval}%
  \pgfmathsetmacro{\entryval}{\AUtoKJM * \entryval}%
  %\fi
  \edef\pgfmathaccuma{\entryval} %
  \pgfkeyslet{/pgfplots/table/create col/next content}\entryval %
} %
]{Erel}\ScanMeSCSMe
\pgfplotstablesave[columns={Tau,Etot,Erel}]{\ScanMeSCSMe}{Results/ScanMeSCSMe.save.dat} 

\begin{figure}
  \caption{Потенциалы внутреннего вращения аналогов сложных эфиров\label{fig:Internal:Rotation:Esters} [переделать координаты, чтобы угол был \ce{H3C-C-Y-CH3}, иначе тут всё слева неправильно, а сам торсионный угол должен быть \ce{X=C-Y-CH3}]}
  \centerfloat{
    \begin{tikzpicture}
      \begin{axis}[legend style={draw=none},
        xlabel={\chemfig{[,0.875]H_3C-[:+30]C(=[:+90]X)-[:-30]\circ-[:+30]CH_3}/$\tau$,~\textdegree},
        xmin=-180, xmax=180,
        xtick={-180,-120,...,180},
        ylabel={$\Delta\Func{E}$,~\si{\kilo\joule\per\mole}},
        ymin=-1, ymax=64]
        \addplot [black,thick,smooth,domain=-180:180] table [x=Tau,y=Erel] 
        {Results/ScanMeOAc.save.dat};\addlegendentry{\chemfig{[,0.675]-[:+30](=[:+90]O)-[:-30]O-[:+30]}~\cmpd{MeOAc}};
        \addplot [blue,thick,smooth,domain=-180:180] table [x=Tau,y=Erel] 
        {Results/ScanMeSAc.save.dat};\addlegendentry{\chemfig{[,0.675]-[:+30](=[:+90]O)-[:-30]S-[:+30]}~\cmpd{MeSAc}};
        \addplot [red,thick,smooth,domain=-180:180] table [x=Tau,y=Erel] 
        {Results/ScanMeOCSMe.save.dat};\addlegendentry{\chemfig{[,0.675]-[:+30](=[:+90]S)-[:-30]O-[:+30]}~\cmpd{MeOCSMe}};
        \addplot [green,thick,smooth,domain=-180:180] table [x=Tau,y=Erel] 
        {Results/ScanMeSCSMe.save.dat};\addlegendentry{\chemfig{[,0.675]-[:+30](=[:+90]S)-[:-30]S-[:+30]}~\cmpd{MeSCSMe}};
      \end{axis}
    \end{tikzpicture}
  }
\end{figure}
